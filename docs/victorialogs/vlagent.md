---
title: vlagent
weight: 4
menu:
  docs:
    weight: 4
    parent: "victorialogs"
    identifier: vlagent
tags:
  - logs
aliases:
  - /vlagent.html
  - /vlagent/index.html
  - /vlagent/
---

`vlagent` is an agent for collecting logs from various sources and storing them in multiple [VictoriaLogs](https://docs.victoriametrics.com/victorialogs/) instances.

## Features

- `vlagent` can discover and collect logs generated by all the pods (containers) in Kubernetes. See [these docs](https://docs.victoriametrics.com/victorialogs/vlagent/#collect-kubernetes-pod-logs).
- `vlagent` can accept logs from popular log collectors in the same way as VictoriaLogs does. See [these docs](https://docs.victoriametrics.com/victorialogs/data-ingestion/).
  It accepts logs over HTTP-based protocols at the TCP port `9429` by default. The port can be changed via `-httpListenAddr` command-line flag.
- `vlagent` can replicate collected logs among multiple VictoriaLogs instances - see [these docs](https://docs.victoriametrics.com/victorialogs/vlagent/#replication-and-high-availability).
- `vlagent` works smoothly in environments with unstable connections to VictoriaLogs instances. If the remote storage is unavailable, the collected logs
  are buffered at the directory specified via `-remoteWrite.tmpDataPath` command-line flag. The buffered logs are sent to remote storage as soon as the connection
  to the remote storage is repaired. The maximum disk usage for the buffer can be limited with `-remoteWrite.maxDiskUsagePerURL` command-line flag.

## Quick Start

Please download and unpack the `vlutils` archive from [releases page](https://github.com/VictoriaMetrics/VictoriaLogs/releases/latest) (
`vlagent` is also available as Docker images on [Docker Hub](https://hub.docker.com/r/victoriametrics/vlagent/tags)
and [Quay](https://quay.io/repository/victoriametrics/vlagent?tab=tags)), then pass the following command-line flags to the `vlagent-prod` binary:

- `-remoteWrite.url` - the VictoriaLogs endpoint for sending the accepted logs to. It must end with `/insert/native`.
  The `-remoteWrite.url` may refer to [DNS SRV](https://en.wikipedia.org/wiki/SRV_record) address. See [these docs](https://docs.victoriametrics.com/victorialogs/vlagent/#srv-urls) for details.

Example command, which starts `vlagent` for accepting logs over HTTP-based [supported protocols](https://docs.victoriametrics.com/victorialogs/data-ingestion/)
at the port `9429` and sends the collected logs to VictoriaLogs instance at `victoria-logs-host:9428`:

```sh
/path/to/vlagent-prod -remoteWrite.url=http://victoria-logs-host:9428/insert/native
```

Pass `-help` to `vlagent` in order to see [the full list of supported command-line flags with their descriptions](https://docs.victoriametrics.com/victorialogs/vlagent/#advanced-usage).

### Replication and high availability

`vlagent` can accept multiple `-remoteWrite.url` command-line flags. In this case it replicates the collected logs among
all the VictoriaLogs instances mentioned in `-remoteWrite.url` command-line flags.

If some of VictoriaLogs instances are temporarily unavailable, then the collected logs are buffered at the directory, which can be specified
via `-remoteWrite.tmpDataPath` command-line flag. The buffered logs are sent to the VictoriaLogs instance as soon as it becomes available.
This guarantees the delivery of all the logs across all the VictoriaLogs instances specified via `-remoteWrite.url` command-line flags.

The on-disk buffer is limited by the available disk space at the `-remoteWrite.tmpDataPath` by default. It is possible to limit it
to the given size via `-remoteWrite.maxDiskUsagePerURL` command-line flag (this flag can be specified individually per each `-remoteWrite.url`).
When the buffer size reaches this limit for the given `-remoteWrite.url`, then the oldest logs are dropped from the buffer and are replaced by the newly
collected logs.

`vlagent` maintains independent buffers for each `-remoteWrite.url`, so the collected logs are delivered to the remaining available VictoriaLogs instances
in a timely manner when some of the VictoriaLogs instances are unavailable.

### Collect Kubernetes Pod logs

The [`victoria-logs-collector`](https://docs.victoriametrics.com/helm/victoria-logs-collector/#quick-start) Helm chart deploys `vlagent`
across all the Kubernetes nodes and enables automatic discovering and collecting all the logs generated by containers across all the pods.
It sends the collected logs to the configured VictoriaLogs instances (either [single-node](https://docs.victoriametrics.com/helm/victoria-logs-single/)
or [cluster](https://docs.victoriametrics.com/helm/victoria-logs-cluster/) instances).

If the configured VictoriaLogs are temporarily unavailable (for example, because of upgrades, configuration changes or other maintenance events),
then `vlagent` buffers the collected logs at the configured persistent volume and sends them to VictoriaLogs instances as soon as they become available,
as described in [Replication and high availability](https://docs.victoriametrics.com/victorialogs/vlagent/#replication-and-high-availability).

## Kubernetes Collector Configuration

In most cases, you don't need to configure `vlagent` manually.
Use [`victoria-logs-collector`](https://docs.victoriametrics.com/helm/victoria-logs-collector/#quick-start) Helm chart instead.

`vlagent` must run on Kubernetes nodes in [DaemonSet mode](https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/).
Pass `-kubernetesCollector` command-line flag to `vlagent` in order to start discovering and collecting logs from all the containers
running inside all the pods on the given Kubernetes node. Pass VictoriaLogs address to store the collected logs
via `-remoteWrite.url` command-line flag.

Here is the minimal configuration for `vlagent` to collect logs on the current Kubernetes node and send them to `http://victoria-logs:9428/insert/native`:

```sh
./vlagent -kubernetesCollector -remoteWrite.url=http://victoria-logs:9428/insert/native
```

`vlagent` can send the copies of the collected logs into multiple destinations.
See [replication and high availability docs](https://docs.victoriametrics.com/victorialogs/vlagent/#replication-and-high-availability) for details.

`vlagent` requires access to Kubernetes API server to watch and get pods (the `watch` and `get` verbs on the `pods` resource) and to get nodes (the `get` verb on the `nodes` resource).
`vlagent` also requires access to the `/var/log/containers` and `/var/log/pods` directories on the Kubernetes node.
For Kubernetes in Docker (in case you run `vlagent` using tools like minikube or kind), you may need to mount `/var/lib` directory.

`vlagent` uses checkpoints to persist its state across restarts.
Default location for checkpoints is `vlagent-kubernetes-checkpoints.json`, which is relative to `-tmpDataPath`.
You can specify a different location for checkpoints with `-kubernetesCollector.checkpointsPath` command-line flag.
Make sure that this file is available for `vlagent` across restarts.
Use [`hostPath`](https://kubernetes.io/docs/concepts/storage/volumes/#hostpath) volume
so the checkpoint file stays on the node disk and is reused across Pod restarts.

`vlagent` automatically parses JSON logs from Kubernetes Pod logs and treats the following fields
as [`_msg`](https://docs.victoriametrics.com/victorialogs/keyconcepts/#message-field) field:
- `message`
- `msg`
- `log`

You can change the default list of `_msg` fields by passing `-kubernetesCollector.msgField` command-line flag with comma-separated list of field names.

`vlagent` extracts timestamp from the log line and uses it as
[`_time`](https://docs.victoriametrics.com/victorialogs/keyconcepts/#time-field) field, using the following fields:
- `time`
- `timestamp`
- `ts`

You can change the default list of `_time` fields by passing `-kubernetesCollector.timeField` command-line flag with comma-separated list of field names.
If none of the specified fields are present in the log line, then `vlagent` uses timestamp when the log line was written by Container Runtime.
Usually, this timestamp is close to the actual time when the log line was written, but it may differ slightly, normally less than a millisecond.

To ignore fields from Kubernetes Pod logs, pass `-kubernetesCollector.ignoreFields` command-line flag with a list of field names to ignore.
You can also configure `vlagent` to add additional fields to all the collected logs,
using `-kubernetesCollector.extraFields` command-line flag, which accepts a JSON object with additional fields.
For example, the following command instructs `vlagent` to add `env=dev` and `cluster=staging` [log fields](https://docs.victoriametrics.com/victorialogs/keyconcepts/#data-model)
for all the collected logs before sending them to `-remoteWrite.url`:

```sh
./vlagent -kubernetesCollector.extraFields='{"env":"dev","cluster":"staging"}' ...
```

To set the default [tenant](http://localhost:1313/victorialogs/#multitenancy) ID for logs collected from Kubernetes Pods, 
pass `-kubernetesCollector.tenantID` command-line flag with a tenant ID in the format `accountID:projectID`.
See also [multitenancy docs for vlagent](https://docs.victoriametrics.com/victorialogs/vlagent/#multitenancy).

`vlagent` uses the following fields as [`_stream`](https://docs.victoriametrics.com/victorialogs/keyconcepts/#stream-fields) fields for Kubernetes Pod logs:
- `kubernetes.container_name`
- `kubernetes.pod_name`
- `kubernetes.pod_namespace`

Use these fields for fast filtering and grouping of logs in VictoriaLogs via [stream filters](https://docs.victoriametrics.com/victorialogs/logsql/#stream-filter).

### Filtering Kubernetes logs

vlagent allows filtering Kubernetes container logs based on metadata fields. 
It is applied before reading the log files, which saves CPU and I/O resources by skipping unwanted data.

Supported metadata fields:

- `kubernetes.container_name` - name of the container.
- `kubernetes.pod_name` - name of the pod.
- `kubernetes.pod_node_name` - name of the node where the pod is running.
- `kubernetes.pod_namespace` - Kubernetes namespace of the pod.
- `kubernetes.pod_ip` - IP address assigned to the pod.
- `kubernetes.container_id` - ID of the container in the runtime.
- `kubernetes.pod_labels.*` - any Pod label (e.g., `kubernetes.pod_labels.app`).
- `kubernetes.pod_annotations.*` - any Pod annotation (e.g., `kubernetes.pod_annotation.logging.vlagent.io/exclude`).
- `kubernetes.node_labels.*` - any Node label (e.g., `kubernetes.io/arch`).
- `kubernetes.node_annotations.*` - any Node annotation (e.g., `disk-type.gke.io/pd-ssd`).

To enable filtering, use the `-kubernetesCollector.excludeFilter` command-line flag with any [LogsQL filter](https://docs.victoriametrics.com/victorialogs/logsql/#filters).
Note that [pipes](https://docs.victoriametrics.com/victorialogs/logsql/#pipes) are not supported in filter expressions.

Note that even if Pod/Node labels and annotations are excluded from logs via `-kubernetesCollector.ignoreFields` 
or `-kubernetesCollector.includePodLabels` (the same for Node labels and annotations) flags,
they are still available for filtering via `-kubernetesCollector.excludeFilter` flag. 
You don't need to include this information in logs just to be able to filter by it.

Example usage:

```sh
./vlagent -remoteWrite.url=http://victoria-logs:9428/insert/native -kubernetesCollector \
  -kubernetesCollector.excludeFilter='kubernetes.pod_annotation.logging.vlagent.io/exclude:=true or kubernetes.pod_namespace:in(test, logging)'
```

This command starts vlagent with a filter that excludes logs from pods labeled with `logging.vlagent.io/exclude: true` 
and skips all logs from the `test` and `logging` namespaces.

### Kubernetes metadata configuration

vlagent automatically enriches collected logs with Kubernetes metadata. 
You can control which metadata fields are attached to every log entry using the following flags:

* `-kubernetesCollector.includePodLabels` (default: `true`) - attach Pod labels to every log entry.
* `-kubernetesCollector.includePodAnnotations` (default: `false`) - attach Pod annotations to every log entry.
* `-kubernetesCollector.includeNodeLabels` (default: `false`) - attach Node labels to every log entry.
* `-kubernetesCollector.includeNodeAnnotations` (default: `false`) - attach Node annotations to every log entry.

Note that vlagent does not update node or pod labels during runtime. 
Therefore, if node/pod metadata changes, you must restart vlagent to apply those changes.

## Monitoring

`vlagent` exports various metrics in Prometheus exposition format at `http://vlagent-host:9429/metrics` page.
We recommend setting up regular scraping of this page either through [`vmagent`](https://docs.victoriametrics.com/victoriametrics/vmagent/) or by a Prometheus-compatible scraper,
so that the exported metrics may be analyzed later.

See [the description of the most important metrics exposed by `vlagent`](https://docs.victoriametrics.com/victorialogs/vlagent-metrics/).

Use [the official Grafana dashboard for `vlagent` state overview](https://grafana.com/grafana/dashboards/24513).
Graphs on this dashboard contain useful hints â€” hover the `i` icon at the top left corner of each graph in order to read them.
If you have suggestions for improvements or have found a bug, please open an issue on GitHub or add a review to the dashboard.

We recommend setting up [alerts](https://github.com/VictoriaMetrics/VictoriaLogs/blob/master/deployment/docker/rules/alerts-vlagent.yml)
via [vmalert](https://docs.victoriametrics.com/victoriametrics/vmalert/) or via Prometheus.

## Multitenancy

`vlagent` can store the collected logs to the following endpoints at VictoriaLogs side or at the downstream `vlagent`:

- `/insert/native`. This endpoint expects `AccountID` and `ProjectID` headers with the tenant ID to write logs to
  according to [these docs](https://docs.victoriametrics.com/victorialogs/#multitenancy).
  These headers can be specified via `-remoteWrite.headers` command-line at `vlagent` side.
  For example, the following command stores logs into `(AccountID=12, ProjectID=34)` tenant:

  ```sh
  ./vlagent -remoteWrite.url=http://victoria-logs:9428/insert/native \
      -remoteWrite.headers='AccountID:12^^ProjectID:34'
  ```

- `/internal/insert`. This endpoint accepts logs with arbitrary tenants:

  ```sh
  ./vlagent -remoteWrite.url=http://victoria-logs:9428/internal/insert
  ```

## Troubleshooting

- It is recommended [setting up the official Grafana dashboard](https://docs.victoriametrics.com/victorialogs/vlagent/#monitoring) in order to monitor the state of `vlagent`.

- It is recommended to increase `-remoteWrite.queues` if `vlagent_remotewrite_pending_data_bytes` [metric](https://docs.victoriametrics.com/victorialogs/vlagent/#monitoring)
  grows constantly. This can improve data ingestion performance to the configured remote storage systems at the cost of higher memory usage.

- If you see gaps in the data pushed by `vlagent` to remote storage when `-remoteWrite.maxDiskUsagePerURL` is set,
  then try increasing `-remoteWrite.queues`. Such gaps may appear because `vlagent` cannot keep up with sending the collected data to remote storage.
  Therefore, it starts dropping the buffered data if the on-disk buffer size exceeds `-remoteWrite.maxDiskUsagePerURL`.

- `vlagent` drops data blocks if remote storage replies with `400 Bad Request` and `404 Not Found` HTTP responses.
  The number of dropped blocks can be monitored via `vlagent_remotewrite_packets_dropped_total` metric exported on the [/metrics page](https://docs.victoriametrics.com/victorialogs/vlagent/#monitoring).

- `vlagent` buffers the collected logs at the `-remoteWrite.tmpDataPath` directory until they are sent to the `-remoteWrite.url`.
  Default value for `-remoteWrite.tmpDataPath` is "vlagent-remotewrite-data", which is relative to `tmpDataPath`.
  The directory can grow large when the remote storage is unavailable for extended periods of time and if the maximum directory size isn't limited
  with `-remoteWrite.maxDiskUsagePerURL` command-line flag.
  If you don't want to send all the buffered data from the directory to remote storage, then simply stop `vlagent` and
  delete the contents of the directory pointed to by `-remoteWrite.tmpDataPath`.

- By default `vlagent` masks `-remoteWrite.url` with `secret-url` values in logs and on the `/metrics` page because
  the URL may contain sensitive information such as auth tokens or passwords.
  Pass `-remoteWrite.showURL` command-line flag when starting `vlagent` in order to see all the valid URLs.

## Profiling

`vlagent` provides handlers for collecting the following [Go profiles](https://blog.golang.org/profiling-go-programs):

- Memory profile can be collected with the following command (replace `0.0.0.0` with the hostname if needed):

```sh
curl http://0.0.0.0:9429/debug/pprof/heap > mem.pprof
```

- CPU profile can be collected with the following command (replace `0.0.0.0` with the hostname if needed):

```sh
curl http://0.0.0.0:9429/debug/pprof/profile > cpu.pprof
```

The command for collecting CPU profile waits for 30 seconds before returning.

The collected profiles may be analyzed with [go tool pprof](https://github.com/google/pprof).

It is safe to share the collected profiles from a security point of view, since they do not contain sensitive information.

## Building from source code

Follow these steps to build vlagent from source code:

- Check out the VictoriaLogs source code:

  ```sh
  git clone https://github.com/VictoriaMetrics/VictoriaLogs
  cd VictoriaLogs
  ```

- Check out a specific commit if needed:

  ```sh
  git checkout <commit-hash-here>
  ```

- Build vlagent (requires Go to be installed on your computer. See [how to install Go](https://golang.org/doc/install)):

  ```sh
  make vlagent
  ```

- Run the built binary:

  ```sh
  bin/vlagent -remoteWrite.url=...
  ```

An alternative approach is to build vlagent inside a Docker builder container. This approach doesn't require Go to be installed,
but it does require Docker on your computer. See [how to install Docker](https://docs.docker.com/engine/install/):

```sh
make vlagent-prod
```

This will build the `victoria-logs-prod` executable inside the `bin` folder.

## Advanced usage

`vlagent` can be fine-tuned with various command-line flags. Run `./vlagent -help` in order to see the full list of these flags with their descriptions and default values:

### Common flags
These flags are available in both VictoriaLogs OSS and VictoriaLogs Enterprise.
{{% content "vlagent_common_flags.md" %}}

### Enterprise flags
These flags are available only in [VictoriaLogs enterprise](https://docs.victoriametrics.com/victoriametrics/enterprise/).
{{% content "vlagent_enterprise_flags.md" %}}
